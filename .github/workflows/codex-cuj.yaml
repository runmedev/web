name: CUJ Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-cuj-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Enable pnpm
        run: corepack enable

      - name: Install runme from runmedev/runme main
        run: |
          mkdir -p "$GITHUB_WORKSPACE/bin"
          GOBIN="$GITHUB_WORKSPACE/bin" go install github.com/runmedev/runme/v3@main
          "$GITHUB_WORKSPACE/bin/runme" --version

      - name: Prepare dependencies (best-effort)
        run: |
          "$GITHUB_WORKSPACE/bin/runme" run configure || true
          "$GITHUB_WORKSPACE/bin/runme" run setup || true

      - name: Run CUJ driver
        run: |
          cd app/test/browser
          npx tsc --target es2020 --module nodenext --moduleResolution nodenext --esModuleInterop --skipLibCheck --outDir .generated cuj-driver.ts
          CUJ_REPO="${GITHUB_REPOSITORY}" CUJ_UPLOAD=false node .generated/cuj-driver.js || true

      - name: Upload CUJ artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cuj-artifacts-${{ github.run_id }}
          path: |
            .artifacts/cuj-runs/**
            app/test/browser/test-output/**
          if-no-files-found: warn

      - name: Upload CUJ summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cuj-summary-${{ github.run_id }}
          path: app/test/browser/test-output/driver/**
          if-no-files-found: warn
