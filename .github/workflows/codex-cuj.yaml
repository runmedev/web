name: Codex CUJ Automation

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review, closed]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  presubmit-codex-request:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Ask Codex to run CUJ scenarios for this PR
        uses: actions/github-script@v7
        with:
          script: |
            const marker = `[codex-cuj-presubmit][sha:${context.payload.pull_request.head.sha}]`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100,
            });
            if (comments.some((c) => c.body && c.body.includes(marker))) {
              core.info(`Skipping duplicate Codex request for ${marker}`);
              return;
            }
            const body = [
              marker,
              `@codex Please run the Critical User Journeys from docs-dev/cujs for commit ${context.payload.pull_request.head.sha}.`,
              '',
              'Required steps:',
              '- Execute `app/test/browser/run-cuj-scenarios.ts`.',
              '- Report assertion-level pass/fail for each CUJ.',
              '- Capture screenshots and scenario logs.',
              '- Record a short CUJ walkthrough video and attach/upload it to this PR thread.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

  postsubmit-codex-request:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Ask Codex to run CUJ scenarios for main
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const mergedSha = context.payload.pull_request.merge_commit_sha ?? context.sha;
            const marker = `[codex-cuj-postsubmit][sha:${mergedSha}]`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });
            if (comments.some((c) => c.body && c.body.includes(marker))) {
              core.info(`Skipping duplicate Codex request for ${marker}`);
              return;
            }
            const body = [
              marker,
              `@codex Please run all scenarios in docs-dev/cujs against main at ${mergedSha}.`,
              '',
              'Required outputs:',
              '- pass/fail summary per CUJ from `app/test/browser/run-cuj-scenarios.ts`',
              '- screenshots and logs attached in the comment',
              '- a short end-to-end CUJ video uploaded to this PR thread',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
