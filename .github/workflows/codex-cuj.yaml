name: Codex CUJ Automation

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  presubmit-codex-request:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Ask Codex to run CUJ scenarios for this PR
        uses: actions/github-script@v7
        with:
          script: |
            const marker = `[codex-cuj-presubmit][sha:${context.payload.pull_request.head.sha}]`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100,
            });
            if (comments.some((c) => c.body && c.body.includes(marker))) {
              core.info(`Skipping duplicate Codex request for ${marker}`);
              return;
            }
            const body = [
              marker,
              `@codex Please run the Critical User Journeys from docs-dev/cujs for commit ${context.payload.pull_request.head.sha}.`,
              '',
              'Required steps:',
              '- Execute `app/test/browser/run-cuj-scenarios.ts`.',
              '- Report assertion-level pass/fail for each CUJ.',
              '- Capture screenshots and scenario logs.',
              '- Record a short CUJ walkthrough video and attach/upload it to this PR thread.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

  postsubmit-codex-request:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Create or find postsubmit CUJ tracking issue
        id: issue
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const title = 'Codex postsubmit CUJ runs';
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });
            const existing = issues.find((i) => i.title === title);
            if (existing) {
              return String(existing.number);
            }
            const created = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: 'Tracking issue for Codex postsubmit CUJ execution artifacts (screenshots/videos).',
            });
            return String(created.data.number);

      - name: Ask Codex to run CUJ scenarios for main
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.result }}
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const marker = `[codex-cuj-postsubmit][sha:${context.sha}]`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            });
            if (comments.some((c) => c.body && c.body.includes(marker))) {
              core.info(`Skipping duplicate Codex request for ${marker}`);
              return;
            }
            const body = [
              marker,
              `@codex Please run all scenarios in docs-dev/cujs against main at ${context.sha}.`,
              '',
              'Required outputs:',
              '- pass/fail summary per CUJ from `app/test/browser/run-cuj-scenarios.ts`',
              '- screenshots and logs attached in the comment',
              '- a short end-to-end CUJ video uploaded to this issue',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body,
            });
