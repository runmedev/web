name: Publish App Assets OCI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.github/workflows/publish-app-assets-oci.yaml'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/app-assets

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build static assets
        run: pnpm -C app run build

      - name: Package static assets
        run: |
          rm -rf oci-artifact
          mkdir -p oci-artifact/assets
          cp -R app/dist/. oci-artifact/assets/
          tar -C oci-artifact -czf app-assets.tgz assets

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ${{ env.REGISTRY }} -u "${{ github.actor }}" --password-stdin

      - name: Compute tags
        id: tags
        run: |
          echo "sha_tag=sha-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "latest_tag=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Push OCI artifact (sha tag)
        run: |
          oras push \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.sha_tag }}" \
            --artifact-type "application/vnd.runmeweb.assets.v1" \
            app-assets.tgz:application/vnd.runmeweb.assets.tar+gzip

      - name: Push OCI artifact (latest tag)
        if: steps.tags.outputs.latest_tag != ''
        run: |
          oras push \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.latest_tag }}" \
            --artifact-type "application/vnd.runmeweb.assets.v1" \
            app-assets.tgz:application/vnd.runmeweb.assets.tar+gzip
