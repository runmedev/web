# aisre-web

This is the UI for the AI SRE.

You can use it at [go/aisre](https://go/aisre).

## Build The UI Locally

Build it with bazel

```sh
cd ~/code/openai
bazel build //project/aisre/aisre-web:web
```

This should build the static assets in `bazel-bin/project/aisre/aisre-web/dist`

```sh
cd ~/code/openai
ls -la bazel-bin/project/aisre/aisre-web/dist
```

## Run a server

### Using Bazel

- Bazel is the preferred way to run the server

```sh
cd ~/code/openai
applied bazel gen
```

- You need to run `applied bazel gen` to generate the `BUILD` file `lib/js/oai_js/BUILD` file.
- For `lib/js/oai_js/BUILD` we are currently relying on the legacy (non-gazelle) solution in `applied gen` to generate the `BUILD` file.
- That depends on `BUILD.in` to add some required rules for js

You can use [ibazel](https://github.com/bazelbuild/bazel-watcher) to interactively run the vite development server

## Start the frontend server

```sh
cd ~/code/openai
ibazel run //project/aisre/aisre-web:web_dev
```

- We use pnpm because it is faster and more correct and its what works with bazel

To start a server with the preview version

```sh
cd ~/code/openai
ibazel run //project/aisre/aisre-web:web_preview
```

## Bazel Build the UI

```sh
cd ~/code/openai/project/aisre/aisre-web
bazel build //project/aisre/aisre-web:web
```

## Deployment

# Configuration

The configuration is defined in the kustomize package `manifests` this is then dumped to service.yaml file

```sh
cd ~/code/openai/project/aisre/aisre-web
cat <<EOF > ./manage/kube/service.yaml
# DO NOT EDIT THIS FILE MANUALLY
# Edit kustomize manaifests in ../../manifests and then run kustomize build

EOF


kustomize build manifests >> ./manage/kube/service.yaml
```

## To deploy your local version

```bash
applied deploy --service aisre-web -l
```

## Updating The UI

The UI is distributed as static assets in a container image.

To update the image

1. Identify the latest container image SHA for the UI image
2. Update the SHA in the manifests/service.Dockerfile

TODO(jlewi): We should build the image using bazel now; it should hopefully be easy to copy assets from the existing image.

## Deploying

### Deploy the UI

```sh
cd ~/code/openai/project/aisre/aisre-web
applied configure buildbox
applied deploy --service aisre-web -l
```

## Sync'ing Vendored Code

TODO(jlewi): Runme has a proper npm package now so we just need to start using that.

# Building With Bazel

## Feedback

Let us know if you have any thoughts, questions, or feedback in [#project-ai-sre](https://openai.enterprise.slack.com/archives/C08AJJ4AWBA)!

# Troubleshooting bazel builds

## Issues resolving dependencies

You can try the following to resolve issues with npm dependencies.

```sh
cd ~/code/openai/
rm -rf node_modules
bazel clean --expunge
bazel build --sandbox_debug //project/aisre/aisre-web:web
```

In general you shouldn't need to run `bazel clean` and if you do it could indicate an issue with the ruleset.

## pnpm hoisting issues vs. bazel

pnpm has a [hoist_deps](https://pnpm.io/settings#dependency-hoisting-settings) mode that's on by default, but bazel layout doesn't match it.
This can lead to issues where the project is building fine with pnpm but fails with bazel. Ideally, we'd disable hoisting in pnpm as
part of migrating oai js to bazel.

The way we hit this was we were getting a build error like the one below

We kept getting the error

```sh
[vite]: Rollup failed to resolve import "@radix-ui/react-arrow" from "/private/var/tmp/_bazel_zbarsky/f2e69c063db44c126c5f4fa34ae1991e/sandbox/darwin-sandbox/4862/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/node_modules/.aspect_rules_js/radix-ui@1.1.3_799832259/node_modules/radix-ui/dist/internal.mjs".
```

- [Slack thread](https://openai.slack.com/archives/C08F91B3TUH/p1752509911607909?thread_ts=1752441269.451749&cid=C08F91B3TUH)
- This is apparently because the package `@radix-ui` is broken and doesn't have a dependency on `@radix-ui/react-arrow` in its package.json.

```lisp
radix-ui@1.1.3(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0):
-    dependencies:
-      '@radix-ui/primitive': 1.1.1
-      '@radix-ui/react-accessible-icon': 1.1.2(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
-      '@radix-ui/react-accordion': 1.2.3(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
-      '@radix-ui/react-alert-dialog': 1.1.6(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
-      '@radix-ui/react-aspect-ratio': 1.1.2(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
-      '@radix-ui/react-avatar': 1.1.3(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
-      '@radix-ui/react-checkbox': 1.1.4(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
-      '@radix-ui/react-collapsible': 1.1.3(@types/react-dom@19.1.6(@types/react@19.1.8))(@types/react@19.1.8)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
```

- For reasons that I don't quite understand when you used `pnpm` to completely rebuild the lock file it fixed the issue as a result of the way pnpm hoists dependencies.
- However, that is a terrible solution because it rebuilds the entire lock file and causes a whole bunch of things to break as a result of version changes
- The correct solution was to add the following to the `package.json` at the root of the repository to fix the radix-ui package.

```json
  "pnpm": {
      ...
      "packageExtensions": {
      "radix-ui": {
          "dependencies": {
          "@radix-ui/react-arrow": "^1.0.0"
          }
      }
  }
}
```

## Updating the lock file

Here's a recipe for updating the lock file e.g. to deal with merge conficlts.

Fetch and merge the latest changes from origin/master

Restore the `pnpm-lock.yaml` file to the fork point and then restore any `oai_js.lock` files that were changed.

```sh
cd ~/code/openai
# or (git rev-parse origin/master)
FORKPOINT=$(git merge-base --fork-point origin/master)
git checkout $FORKPOINT pnpm-lock.yaml

# List changed files vs FORKPOINT
changed_files=$(git diff --name-only "$FORKPOINT")

echo "Changed files:"
echo "$changed_files"

# Filter for any file ending in oai_js.lock
oai_lock_files=$(echo "$changed_files" | grep -E '/?oai_js\.lock$' || true)

# Restore each oai_js.lock file from FORKPOINT
while IFS= read -r file; do
  [ -z "$file" ] && continue
  echo "Restoring $file from $FORKPOINT"
  # Because project/aisre/aisre-web/oai_js.lock won't be in fork point
  git checkout "$FORKPOINT" -- "$file" || true
done <<< "$oai_lock_files"
```

Run `js install` to update the `pnpm-lock.yaml` file based on the current state of the `package.json` file.

```sh
cd ~/code/openai/project/aisre/aisre-web
js install
```

- Under the hood this is just running `pnpm install --no-frozen-lockfile`
